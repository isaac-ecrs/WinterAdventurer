@using MudBlazor
@using WinterAdventurer.Library.Models
@using WinterAdventurer.Components.Shared
@using WinterAdventurer.Data

<EditForm Model=Workshops OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <MudGrid>
        @if (!Success)
        {
            <MudItem xs="12">
                <MudPaper Class="pa-4 mud-height-full">
                    <MudText Color="@Color.Error">
                        <ValidationSummary />
                    </MudText>
                </MudPaper>
            </MudItem>
        }
        <MudItem xs="12" md="6" id="event-name-field">
            <MudTextField Label="Event Name" @bind-Value="EventName"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Event"
                          Placeholder="@DefaultEventName"
                          HelperText="Name for the master schedule" />
        </MudItem>
        <MudItem xs="12" md="6" id="blank-schedules-field">
            <MudNumericField Label="Blank Schedules"
                          Value="@BlankScheduleCount"
                          ValueChanged="@((int value) => BlankScheduleCountChanged.InvokeAsync(value))"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.PersonAddAlt"
                          Min="0"
                          HelperText="Number of blank schedules to generate (for attendees not in roster)" />
        </MudItem>
        @for (int i = 0; i < Workshops.Count; i++)
        {
            var workshop = Workshops[i];
            var currentIndex = i; // Capture index for this iteration
            <MudItem xs="6">
                <WorkshopCard Workshop="workshop"
                             CardIndex="@currentIndex"
                             AllWorkshops="Workshops"
                             AvailableLocations="AvailableLocations"
                             LocationListVersion="LocationListVersion"
                             OnLocationChanged="OnWorkshopLocationChanged"
                             OnDeleteLocationRequested="OnDeleteLocationRequested" />
            </MudItem>
        }
        <PdfGenerationButtons IsDisabled="IsDisabled"
                              IsLoading="IsLoading"
                              ShowSuccess="ShowSuccess"
                              OnCreateMasterSchedule="OnCreateMasterSchedule" />
    </MudGrid>
</EditForm>

@code {
    /// <summary>
    /// List of all workshops to display in the grid
    /// </summary>
    [Parameter, EditorRequired]
    public List<Workshop> Workshops { get; set; } = default!;

    /// <summary>
    /// Name of the event for the master schedule PDF
    /// </summary>
    [Parameter, EditorRequired]
    public string EventName { get; set; } = default!;

    /// <summary>
    /// Callback invoked when the event name changes
    /// </summary>
    [Parameter]
    public EventCallback<string> EventNameChanged { get; set; }

    /// <summary>
    /// Default event name to show as placeholder
    /// </summary>
    [Parameter, EditorRequired]
    public string DefaultEventName { get; set; } = default!;

    /// <summary>
    /// Number of blank schedules to generate (for attendees not in roster)
    /// </summary>
    [Parameter, EditorRequired]
    public int BlankScheduleCount { get; set; } = 0;

    /// <summary>
    /// Callback invoked when the blank schedule count changes
    /// </summary>
    [Parameter]
    public EventCallback<int> BlankScheduleCountChanged { get; set; }

    /// <summary>
    /// Indicates whether form submission was successful
    /// </summary>
    [Parameter]
    public bool Success { get; set; }

    /// <summary>
    /// Indicates whether PDF generation should be disabled (due to validation errors)
    /// </summary>
    [Parameter]
    public bool IsDisabled { get; set; }

    /// <summary>
    /// Indicates whether PDF is currently being generated (shows loading spinner)
    /// </summary>
    [Parameter]
    public bool IsLoading { get; set; }

    /// <summary>
    /// Indicates whether to show the success message after PDF generation
    /// </summary>
    [Parameter]
    public bool ShowSuccess { get; set; }

    /// <summary>
    /// List of all available locations from the database (with tags loaded)
    /// </summary>
    [Parameter, EditorRequired]
    public List<Location> AvailableLocations { get; set; } = default!;

    /// <summary>
    /// Version number to force refresh of all workshop cards when locations change
    /// </summary>
    [Parameter, EditorRequired]
    public int LocationListVersion { get; set; }

    /// <summary>
    /// Callback invoked when form is submitted (Build PDF button clicked)
    /// </summary>
    [Parameter]
    public EventCallback OnValidSubmit { get; set; }

    /// <summary>
    /// Callback invoked when Create Master Schedule button clicked
    /// </summary>
    [Parameter]
    public EventCallback OnCreateMasterSchedule { get; set; }

    /// <summary>
    /// Callback invoked when a workshop's location changes
    /// </summary>
    [Parameter]
    public EventCallback<Workshop> OnWorkshopLocationChanged { get; set; }

    /// <summary>
    /// Callback invoked when user requests to delete a location
    /// </summary>
    [Parameter]
    public EventCallback<string> OnDeleteLocationRequested { get; set; }
}

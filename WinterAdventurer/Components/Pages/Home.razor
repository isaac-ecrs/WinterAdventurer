@page "/"
@using MigraDoc.Rendering
@using PdfSharp.Fonts
@using PdfSharp.Pdf
@using WinterAdventurer.Library
@using System
@using System.IO
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<h1>Import Excel File</h1>

<InputFile title="Upload an Excel file" OnChange="UploadExcel" accept=".xlsx" />

@if (isLoading)
{
    <p>Uploading...</p>
}

@if (workshops != null && workshops.Count > 0)
{
    <a href=@downloadFileName download="schedules.pdf">Download File</a>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Leader</th>
                <th>Type</th>
                <th>Max Participants</th>
                <th>Min Age</th>
                <th>Selections</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var workshop in workshops)
            {
                <tr>
                    <td>@workshop.Name</td>
                    <td>@workshop.Leader</td>
                    <td>@workshop.Type</td>
                    <td>@workshop.MaxParticipants</td>
                    <td>@workshop.MinAge</td>
                    <td>@string.Join(", ", workshop.Selections)</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<WinterAdventurer.Library.Models.Workshop> workshops = new List<Library.Models.Workshop>();
    private bool isLoading;
    public string? downloadFileName;

    private async Task UploadExcel(InputFileChangeEventArgs e)
    {
        isLoading = true;
        workshops.Clear();

        using (var stream = new FileStream(e.File.Name, FileMode.OpenOrCreate, FileAccess.ReadWrite))
        {
            var excelUtilities = new ExcelUtilities();
            await e.File.OpenReadStream().CopyToAsync(stream);
            excelUtilities.ImportExcel(stream);
            workshops = excelUtilities.Workshops;
            SetDownloadLink(excelUtilities);
        }

        isLoading = false;
    }

    private void SetDownloadLink(ExcelUtilities excelUtilities)
    {
        try
        {
            var renderer = new PdfDocumentRenderer()
            {
                Document = excelUtilities.CreatePdf()
            };

            renderer.Document = excelUtilities.CreatePdf();
            renderer.RenderDocument();

            using(var stream = new MemoryStream())
            {
                renderer.PdfDocument.Save(stream);
                var base64File = Convert.ToBase64String(stream.ToArray());
                downloadFileName = $"data:application/pdf;base64,{base64File}";
            }            
        }
        catch(Exception e)
        {
            Console.WriteLine(e);
        }
    }
}
